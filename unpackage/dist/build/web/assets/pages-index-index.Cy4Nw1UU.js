import{d as e,n as t,s as o,o as n,c as a,w as s,_ as r,a as i,b as c,t as l,e as u,f as d,g as f,r as p,F as h,h as g,i as _,j as w}from"./index-Ca6a1Wgz.js";import{g as m}from"./http.B0enqeDY.js";import{_ as v}from"./_plugin-vue_export-helper.BCo6x5W8.js";function y(e,t,o,n){return new(o||(o=Promise))((function(a,s){function r(e){try{c(n.next(e))}catch(t){s(t)}}function i(e){try{c(n.throw(e))}catch(t){s(t)}}function c(e){var t;e.done?a(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(r,i)}c((n=n.apply(e,t||[])).next())}))}"function"==typeof SuppressedError&&SuppressedError;const k={appId:"wx001a24bd7764b30a",scope:"snsapi_base",state:"STATE"},I={getAccessToken:"/user/wechat-login",getUserInfo:"/api/wechat/getUserInfo"};function x(){const e=window.location.search;console.log(e,"url");const t=new URLSearchParams(e);return{code:t.get("code"),state:t.get("state")}}function S(){const e=localStorage.getItem("wechat_user_info");return e?JSON.parse(e):null}function C(){return e=this,t=null,o=function*(){console.log(x(),"getUrlParams()");const{code:e}=x(),t=S();if(t)return t;if(!e){const e=encodeURIComponent(function(){let e=window.location.href;return-1!==e.indexOf("#")&&(e=e.split("#")[0]),-1!==e.indexOf("?")&&(e=e.substring(0,e.indexOf("?"))),e}()),t="https://open.weixin.qq.com/connect/oauth2/authorize?appid=".concat(k.appId,"&redirect_uri=").concat(e,"&response_type=code&scope=").concat(k.scope);return console.log(window.location.href,"window.location.href"),console.log("生成的微信授权链接:",t),window.location.href=t,null}try{const t=yield m(I.getAccessToken,{code:e});return console.log(t.openid,"tokenResponse"),localStorage.setItem("token",t.openid),o=t,localStorage.setItem("wechat_user_info",JSON.stringify(o)),t}catch(n){throw console.error("微信授权失败:",n),localStorage.removeItem("wechat_user_info"),n}var o},new Promise(((n,a)=>{var s=e=>{try{i(o.next(e))}catch(t){a(t)}},r=e=>{try{i(o.throw(e))}catch(t){a(t)}},i=e=>e.done?n(e.value):Promise.resolve(e.value).then(s,r);i((o=o.apply(e,t)).next())}));var e,t,o}const b=v(e({data:()=>({userInfo:null,loading:!0,reportList:[]}),onLoad(){this.initializeAuth()},methods:{initializeAuth(){return y(this,void 0,void 0,(function*(){try{this.loading=!0;const e=S();if(e)return console.log(4),this.userInfo=e,this.loading=!1,Promise.resolve(null);const t=yield C();console.log(1),t&&(this.userInfo=t)}catch(e){o({title:"授权失败，请重试",icon:"none"}),console.error("授权失败:",e)}finally{this.loading=!1}}))},viewHistory(){t({url:"/pages/patient/history"})},handleGetUserinfo(){(e=>{m("/user/wechat-login/?code=".concat(e))})(x().code)},fetchReportList(){return y(this,void 0,void 0,(function*(){try{const e=yield getReportList();200===e.code&&(this.reportList=Object.values(e.data))}catch(e){o({title:"获取报告失败",icon:"none"})}}))},viewReport(e=null){window.open("http://277fbfd6.r9.cpolar.top/report/wechat-export/?report_id=".concat(e.id))}}}),[["render",function(e,t,o,m,v,y){const k=g,I=r,x=_,S=w;return n(),a(I,null,{default:s((()=>[i(I,{class:"header"},{default:s((()=>[i(k,{class:"title"},{default:s((()=>[c("用户报告")])),_:1})])),_:1}),v.userInfo?(n(),a(I,{key:0,class:"user-info"},{default:s((()=>[i(I,{class:"user-avatar"},{default:s((()=>[i(x,{src:v.userInfo.headimgurl,mode:"aspectFill"},null,8,["src"])])),_:1}),i(I,{class:"user-details"},{default:s((()=>[i(k,{class:"nickname"},{default:s((()=>[c(l(v.userInfo.nickname),1)])),_:1}),i(k,{class:"other-info"},{default:s((()=>[c(l(v.userInfo.province)+" "+l(v.userInfo.city),1)])),_:1})])),_:1})])),_:1})):v.loading?(n(),a(I,{key:1,class:"loading"},{default:s((()=>[i(k,null,{default:s((()=>[c("加载中...")])),_:1})])),_:1})):u("",!0),i(I,{class:"actions"},{default:s((()=>[i(S,{onClick:y.viewHistory},{default:s((()=>[c("查看历史检测记录")])),_:1},8,["onClick"]),i(S,{onClick:e.viewPdfReport},{default:s((()=>[c("查看PDF报告")])),_:1},8,["onClick"]),i(S,{onClick:y.handleGetUserinfo},{default:s((()=>[c("请求按钮")])),_:1},8,["onClick"])])),_:1}),d("div",{id:"ai-chat"}),v.reportList.length?(n(),a(I,{key:2},{default:s((()=>[(n(!0),f(h,null,p(v.reportList,(e=>(n(),a(I,{key:e.id,class:"report-card"},{default:s((()=>[i(I,null,{default:s((()=>[c(l(e.name),1)])),_:2},1024),i(I,null,{default:s((()=>[c("机构："+l(e.company),1)])),_:2},1024),i(I,null,{default:s((()=>[c(l(e.time),1)])),_:2},1024),i(S,{onClick:t=>y.viewReport(e)},{default:s((()=>[c("查看报告")])),_:2},1032,["onClick"])])),_:2},1024)))),128))])),_:1})):u("",!0)])),_:1})}],["__scopeId","data-v-c9a6b32c"]]);export{b as default};
