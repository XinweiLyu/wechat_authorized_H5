{"version":3,"file":"wechat.js","sources":["utils/services/wechat.js"],"sourcesContent":["import { get } from '../request/http';\r\nimport config from '../config/wechat';\r\n\r\n// 获取当前页面URL（去除参数）\r\nfunction getCurrentPageUrl() {\r\n    let url = window.location.href;\r\n    if (url.indexOf('#') !== -1) {\r\n        url = url.split('#')[0];\r\n    }\r\n    if (url.indexOf('?') !== -1) {\r\n        url = url.substring(0, url.indexOf('?'));\r\n    }\r\n    return url;\r\n}\r\n\r\n// 获取URL中的参数\r\nfunction getUrlParams() {\r\n    const url = window.location.search;\r\n    console.log(url, 'url');\r\n    const params = new URLSearchParams(url);\r\n    return {\r\n        code: params.get('code'),\r\n        state: params.get('state')\r\n    };\r\n}\r\n\r\n// 存储用户信息\r\nfunction saveUserInfo(userInfo) {\r\n    localStorage.setItem('wechat_user_info', JSON.stringify(userInfo));\r\n}\r\n\r\n// 获取存储的用户信息\r\nexport function getStoredUserInfo() {\r\n    const userInfo = localStorage.getItem('wechat_user_info');\r\n    return userInfo ? JSON.parse(userInfo) : null;\r\n}\r\n\r\n// 清除用户信息\r\nexport function clearUserInfo() {\r\n    localStorage.removeItem('wechat_user_info');\r\n}\r\n\r\n// 微信授权\r\nexport async function wechatAuth() {\r\n    console.log(getUrlParams(), 'getUrlParams()');\r\n    const { code } = getUrlParams();\r\n    const storedUserInfo = getStoredUserInfo();\r\n\r\n    // 如果已有用户信息，直接返回\r\n    if (storedUserInfo) {\r\n        return storedUserInfo;\r\n    }\r\n\r\n    // 如果没有code，重定向到微信授权页\r\n    if (!code) {\r\n        const redirectUri = encodeURIComponent(getCurrentPageUrl());\r\n\t\t// 微信后台配置，重定向跳转页面，截取code\r\n\t\t// TODO\r\n\t\t//www.baidu.com?code=jhsadfghj455565\r\n\t\t// 后端跳转页面时，截图路劲上的code参数，然后带着code参数去点用微信官方和接口\r\n        // const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${config.officialAccount.appId}&redirect_uri=${redirectUri}&response_type=code&scope=${config.officialAccount.scope}&state=${config.officialAccount.state}#wechat_redirect`;\r\n\t\t// const authUrl = `https://open.weixin.qq.com/connect/oauth2/authorize?appid=${config.officialAccount.appId}&redirect_uri=http://www.cocoyam.cn&response_type=code&scope=${config.officialAccount.scope}&state=${config.officialAccount.state}#wechat_redirect`;\r\n        window.location.href = authUrl;\r\n        return null;\r\n    }\r\n\r\n    try {\r\n        // 使用code获取access_token和用户信息\r\n        const tokenResponse = await get(config.api.getAccessToken, { code });\r\n        if (!tokenResponse.access_token) {\r\n            throw new Error('Failed to get access token');\r\n        }\r\n\r\n        // 获取用户信息\r\n        const userInfo = await get(config.api.getUserInfo, {\r\n            access_token: tokenResponse.access_token,\r\n            openid: tokenResponse.openid\r\n        });\r\n\r\n        // 保存用户信息\r\n        saveUserInfo(userInfo);\r\n        return userInfo;\r\n    } catch (error) {\r\n        console.error('微信授权失败:', error);\r\n        clearUserInfo();\r\n        throw error;\r\n    }\r\n} "],"names":["uni","get","config"],"mappings":";;;;AAIA,SAAS,oBAAoB;AACzB,MAAI,MAAM,OAAO,SAAS;AAC1B,MAAI,IAAI,QAAQ,GAAG,MAAM,IAAI;AACzB,UAAM,IAAI,MAAM,GAAG,EAAE,CAAC;AAAA,EACzB;AACD,MAAI,IAAI,QAAQ,GAAG,MAAM,IAAI;AACzB,UAAM,IAAI,UAAU,GAAG,IAAI,QAAQ,GAAG,CAAC;AAAA,EAC1C;AACD,SAAO;AACX;AAGA,SAAS,eAAe;AACpB,QAAM,MAAM,OAAO,SAAS;AAC5BA,gBAAY,MAAA,MAAA,OAAA,kCAAA,KAAK,KAAK;AACtB,QAAM,SAAS,IAAI,gBAAgB,GAAG;AACtC,SAAO;AAAA,IACH,MAAM,OAAO,IAAI,MAAM;AAAA,IACvB,OAAO,OAAO,IAAI,OAAO;AAAA,EACjC;AACA;AAGA,SAAS,aAAa,UAAU;AAC5B,eAAa,QAAQ,oBAAoB,KAAK,UAAU,QAAQ,CAAC;AACrE;AAGO,SAAS,oBAAoB;AAChC,QAAM,WAAW,aAAa,QAAQ,kBAAkB;AACxD,SAAO,WAAW,KAAK,MAAM,QAAQ,IAAI;AAC7C;AAGO,SAAS,gBAAgB;AAC5B,eAAa,WAAW,kBAAkB;AAC9C;AAGO,eAAe,aAAa;AAC/BA,gBAAY,MAAA,MAAA,OAAA,kCAAA,aAAY,GAAI,gBAAgB;AAC5C,QAAM,EAAE,SAAS;AACjB,QAAM,iBAAiB;AAGvB,MAAI,gBAAgB;AAChB,WAAO;AAAA,EACV;AAGD,MAAI,CAAC,MAAM;AACa,uBAAmB,kBAAiB,CAAE;AAO1D,WAAO,SAAS,OAAO;AACvB,WAAO;AAAA,EACV;AAED,MAAI;AAEA,UAAM,gBAAgB,MAAMC,mBAAAA,IAAIC,oBAAM,OAAC,IAAI,gBAAgB,EAAE,KAAI,CAAE;AACnE,QAAI,CAAC,cAAc,cAAc;AAC7B,YAAM,IAAI,MAAM,4BAA4B;AAAA,IAC/C;AAGD,UAAM,WAAW,MAAMD,mBAAAA,IAAIC,oBAAAA,OAAO,IAAI,aAAa;AAAA,MAC/C,cAAc,cAAc;AAAA,MAC5B,QAAQ,cAAc;AAAA,IAClC,CAAS;AAGD,iBAAa,QAAQ;AACrB,WAAO;AAAA,EACV,SAAQ,OAAO;AACZF,kBAAc,MAAA,MAAA,SAAA,kCAAA,WAAW,KAAK;AAC9B;AACA,UAAM;AAAA,EACT;AACL;;;"}